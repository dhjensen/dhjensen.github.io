<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Search for Orphaned vmdk files return exception on large Datastores | dhjensen.dk</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://dhjensen.dk/posts/search-for-orphaned-vmdk-files-return-exception-on-large-datastores/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><!-- Matomo --><script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//matomo.dhjensen.dk/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script><noscript><p><img referrerpolicy="no-referrer-when-downgrade" src="//matomo.dhjensen.dk/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code --><meta name="author" content="Daniel Jensen">
<link rel="prev" href="../lync-response-group-usage-report-very-slow-or-not-completing/" title="Lync Response Group Usage Report very slow or not completing" type="text/html">
<meta property="og:site_name" content="dhjensen.dk">
<meta property="og:title" content="Search for Orphaned vmdk files return exception on large Datastores">
<meta property="og:url" content="https://dhjensen.dk/posts/search-for-orphaned-vmdk-files-return-exception-on-large-datastores/">
<meta property="og:description" content="One of the challenges working with VMware vCenter is keeping clean and healthy datastores. Making sure only vmdk files registered with active VMs is stored on Datastores is one example.
For this purpo">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-08-13T09:16:00+02:00">
<meta property="article:tag" content="Datastore">
<meta property="article:tag" content="ESXCLI">
<meta property="article:tag" content="ESXi">
<meta property="article:tag" content="PowerCLI">
<meta property="article:tag" content="Powershell">
<meta property="article:tag" content="timeout">
<meta property="article:tag" content="vCenter">
<meta property="article:tag" content="VDI">
<meta property="article:tag" content="View">
<meta property="article:tag" content="VMware">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">dhjensen.dk</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../pages/about-me/index.html" class="nav-link">About me</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Socials</a>
            <div class="dropdown-menu">
                    <a href="https://linkedin.com/in/dhjensen" class="dropdown-item">Linkedin</a>
                    <a href="https://facebook.com/dhjensen" class="dropdown-item">Facebook</a>
                    <a href="https://github.com/dhjensen" class="dropdown-item">GitHub</a>
            </div>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Links</a>
            <div class="dropdown-menu">
                    <a href="https://www.favicon-generator.org/" class="dropdown-item">Favicon Generator</a>
                    <a href="https://getnikola.com/" class="dropdown-item">Nikola</a>
                    <a href="https://www.python.org/" class="dropdown-item">Python</a>
            </div>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Search for Orphaned vmdk files return exception on large Datastores</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Daniel Jensen
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2015-08-13T09:16:00+02:00" itemprop="datePublished" title="2015-08-13 09:16">2015-08-13 09:16</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>One of the challenges working with VMware vCenter is keeping clean and healthy datastores. Making sure only vmdk files registered with active VMs is stored on Datastores is one example.<br>
For this purposes there are numerous scripts around that will compare the files of registered VMs with the actual list of vmdk files found in a Datastore<br>
Examples:  </p>
<ul>
<li><a href="https://communities.vmware.com/message/1527123">https://communities.vmware.com/message/1527123</a></li>
<li><a href="http://virtuallyjason.blogspot.dk/2013/08/orphaned-vmdk-files.html">http://virtuallyjason.blogspot.dk/2013/08/orphaned-vmdk-files.html</a></li>
<li><a href="http://www.lucd.info/2011/04/25/orphaned-files-and-folders-spring-cleaning/">http://www.lucd.info/2011/04/25/orphaned-files-and-folders-spring-cleaning/</a></li>
</ul>
<p>There is however one problem no one seem to be able to address at all across all these scripts. When you search "very" large datastores and the ESXCLI / PowerCLI have been running for 15 minutes the script get an exception. (Our VDI linked clone datastore is very large)  </p>
<div class="code"><pre class="code literal-block"><span class="n">Exception</span> <span class="n">calling</span> <span class="s2">"SearchDatastoreSubFolders"</span> <span class="n">with</span> <span class="s2">"2"</span> <span class="n">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="s2">"An error o</span>
<span class="s2">ccurred while communicating with the remote host."</span>
<span class="n">At</span> <span class="n">xxxxx</span>
<span class="p">+</span>     <span class="nv">$searchResult</span> <span class="p">=</span> <span class="nv">$dsBrowser</span><span class="p">.</span><span class="n">SearchDatastoreSubFolders</span> <span class="p">&lt;&lt;&lt;&lt;</span> <span class="p">(</span><span class="nv">$rootPath</span><span class="p">,</span> <span class="nv">$se</span>
<span class="n">archSpec</span><span class="p">)</span>
    <span class="p">+</span> <span class="n">CategoryInfo</span>          <span class="p">:</span> <span class="n">NotSpecified</span><span class="p">:</span> <span class="p">(:)</span> <span class="p">[],</span> <span class="n">MethodInvocationException</span>
    <span class="p">+</span> <span class="n">FullyQualifiedErrorId</span> <span class="p">:</span> <span class="n">DotNetMethodException</span><span class="s2">".</span>
</pre></div>

<p>I noticed the exception message was about the remote host so I figured it must be vCenter / ESXi related.  </p>
<p>Based on above finding I found this <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1017253">VMware KB article</a> that describe how to increase the timeout for tasks to vCenter and ESXCLI to much more than the default 15 minutes. I implemented the KB article on my vCenter server and on all the ESXi hosts in the cluster. This did the trick for me and I can now complete the datastore search. More specific I'm now able to complete this line of code from the scripts without the exception:  </p>
<div class="code"><pre class="code literal-block"><span class="nv">$xxx</span><span class="p">.</span><span class="n">SearchDatastoreSubFolders</span><span class="p">(</span><span class="nv">$rootPath</span><span class="p">,</span> <span class="nv">$searchSpec</span><span class="p">)</span>
</pre></div>

<p>I will not list my specific actions as they are covered in the KB article. However the article doesn't mention that the <code>vpxa.cfg</code> file is read only on the ESXi 5.5 host so you need to run the following to get write access  </p>
<div class="code"><pre class="code literal-block">chmod<span class="w"> </span>u+w<span class="w"> </span>/etc/vmware/vpxa/vpxa.cfg
</pre></div>

<p>I hope this makes sense for everyone.
Please comment if you have any questions or feedback.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/datastore/" rel="tag">Datastore</a></li>
            <li><a class="tag p-category" href="../../categories/esxcli/" rel="tag">ESXCLI</a></li>
            <li><a class="tag p-category" href="../../categories/esxi/" rel="tag">ESXi</a></li>
            <li><a class="tag p-category" href="../../categories/powercli/" rel="tag">PowerCLI</a></li>
            <li><a class="tag p-category" href="../../categories/powershell/" rel="tag">Powershell</a></li>
            <li><a class="tag p-category" href="../../categories/timeout/" rel="tag">timeout</a></li>
            <li><a class="tag p-category" href="../../categories/vcenter/" rel="tag">vCenter</a></li>
            <li><a class="tag p-category" href="../../categories/vdi/" rel="tag">VDI</a></li>
            <li><a class="tag p-category" href="../../categories/view/" rel="tag">View</a></li>
            <li><a class="tag p-category" href="../../categories/vmware/" rel="tag">VMware</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../lync-response-group-usage-report-very-slow-or-not-completing/" rel="prev" title="Lync Response Group Usage Report very slow or not completing">Previous post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2025         <a href="mailto:dhjen@outlook.com">Daniel Jensen</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
