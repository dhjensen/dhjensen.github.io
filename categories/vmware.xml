<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>dhjensen.dk (Posts about VMware)</title><link>https://dhjensen.dk/</link><description></description><atom:link href="https://dhjensen.dk/categories/vmware.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><copyright>Contents © 2025 &lt;a href="mailto:dhjen@outlook.com"&gt;Daniel Jensen&lt;/a&gt; </copyright><lastBuildDate>Sun, 31 Aug 2025 16:04:59 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Search for Orphaned vmdk files return exception on large Datastores</title><link>https://dhjensen.dk/posts/search-for-orphaned-vmdk-files-return-exception-on-large-datastores/</link><dc:creator>Daniel Jensen</dc:creator><description>&lt;p&gt;One of the challenges working with VMware vCenter is keeping clean and healthy datastores. Making sure only vmdk files registered with active VMs is stored on Datastores is one example.&lt;br&gt;
For this purposes there are numerous scripts around that will compare the files of registered VMs with the actual list of vmdk files found in a Datastore&lt;br&gt;
Examples:  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://communities.vmware.com/message/1527123"&gt;https://communities.vmware.com/message/1527123&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://virtuallyjason.blogspot.dk/2013/08/orphaned-vmdk-files.html"&gt;http://virtuallyjason.blogspot.dk/2013/08/orphaned-vmdk-files.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.lucd.info/2011/04/25/orphaned-files-and-folders-spring-cleaning/"&gt;http://www.lucd.info/2011/04/25/orphaned-files-and-folders-spring-cleaning/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There is however one problem no one seem to be able to address at all across all these scripts. When you search "very" large datastores and the ESXCLI / PowerCLI have been running for 15 minutes the script get an exception. (Our VDI linked clone datastore is very large)  &lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;&lt;span class="n"&gt;Exception&lt;/span&gt; &lt;span class="n"&gt;calling&lt;/span&gt; &lt;span class="s2"&gt;"SearchDatastoreSubFolders"&lt;/span&gt; &lt;span class="n"&gt;with&lt;/span&gt; &lt;span class="s2"&gt;"2"&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="s2"&gt;"An error o&lt;/span&gt;
&lt;span class="s2"&gt;ccurred while communicating with the remote host."&lt;/span&gt;
&lt;span class="n"&gt;At&lt;/span&gt; &lt;span class="n"&gt;xxxxx&lt;/span&gt;
&lt;span class="p"&gt;+&lt;/span&gt;     &lt;span class="nv"&gt;$searchResult&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nv"&gt;$dsBrowser&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SearchDatastoreSubFolders&lt;/span&gt; &lt;span class="p"&gt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$rootPath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;$se&lt;/span&gt;
&lt;span class="n"&gt;archSpec&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;CategoryInfo&lt;/span&gt;          &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;NotSpecified&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(:)&lt;/span&gt; &lt;span class="p"&gt;[],&lt;/span&gt; &lt;span class="n"&gt;MethodInvocationException&lt;/span&gt;
    &lt;span class="p"&gt;+&lt;/span&gt; &lt;span class="n"&gt;FullyQualifiedErrorId&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;DotNetMethodException&lt;/span&gt;&lt;span class="s2"&gt;".&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I noticed the exception message was about the remote host so I figured it must be vCenter / ESXi related.  &lt;/p&gt;
&lt;p&gt;Based on above finding I found this &lt;a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;amp;cmd=displayKC&amp;amp;externalId=1017253"&gt;VMware KB article&lt;/a&gt; that describe how to increase the timeout for tasks to vCenter and ESXCLI to much more than the default 15 minutes. I implemented the KB article on my vCenter server and on all the ESXi hosts in the cluster. This did the trick for me and I can now complete the datastore search. More specific I'm now able to complete this line of code from the scripts without the exception:  &lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;&lt;span class="nv"&gt;$xxx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SearchDatastoreSubFolders&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$rootPath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;$searchSpec&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I will not list my specific actions as they are covered in the KB article. However the article doesn't mention that the &lt;code&gt;vpxa.cfg&lt;/code&gt; file is read only on the ESXi 5.5 host so you need to run the following to get write access  &lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code literal-block"&gt;chmod&lt;span class="w"&gt; &lt;/span&gt;u+w&lt;span class="w"&gt; &lt;/span&gt;/etc/vmware/vpxa/vpxa.cfg
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I hope this makes sense for everyone.
Please comment if you have any questions or feedback.&lt;/p&gt;</description><category>Datastore</category><category>ESXCLI</category><category>ESXi</category><category>PowerCLI</category><category>Powershell</category><category>timeout</category><category>vCenter</category><category>VDI</category><category>View</category><category>VMware</category><guid>https://dhjensen.dk/posts/search-for-orphaned-vmdk-files-return-exception-on-large-datastores/</guid><pubDate>Thu, 13 Aug 2015 07:16:00 GMT</pubDate></item></channel></rss>